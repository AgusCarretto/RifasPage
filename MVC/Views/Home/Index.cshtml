@model IEnumerable<LogicaNegocio.Rifa>
@section Styles {
    <link rel="stylesheet" href="~/css/rigas-grid.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/modalCompra.css" asp-append-version="true" />
}
@{
    ViewData["Title"] = "Venta de Rifas";
}



@if (!Model.Any())
{
    <div class="alert alert-info">No hay rifas cargadas en la base de datos.</div>
}


<div class="container">
    <div class="text-center my-5">
        <h1 class="brand-title">LONDRES 2027</h1>
        <p class="brand-subtitle">Sorteos & Rifas</p>
        <hr style="width: 100px; border: 2px solid #2e7d32; margin: 10px auto;">

       
    </div>


    <section id="descripcion" class="mb-5 py-2 py-md-4 bg-light">
        @await Html.PartialAsync("_SeccionDescripcion")
    </section>

    <hr style="width: 100px; border: 2px solid #2e7d32; margin: 10px auto;">


    <section id="rifas" class="py-5">

        <div class="d-flex justify-content-center gap-3 mb-4">
            <span class="badge bg-success">Disponible</span>
            <span class="badge bg-warning text-dark">Pendiente/Reservado</span>
            <span class="badge bg-danger">No disponible</span>
        </div>
        
        <div class="container">
            <div class="container mb-3">
                <div class="row justify-content-center">
                    <div class="col-md-8 text-center">

                       

                        <p class="text-muted fs-5 ">
                            Solo quedan <strong>@ViewBag.RifasRestantes</strong> números.
                        </p>

                        <div class="text-center my-3">
                            <div class="mb-1" style="font-size: 1.5rem;">🏆</div>

                            <div class="text-muted small fw-bold text-uppercase mb-2" style="letter-spacing: 2px; font-size: 0.65rem;">
                                Persona que más apoyó
                            </div>

                            <div>
                                <span class="badge rounded-pill bg-black px-4 py-2" style="font-size: 0.9rem; font-weight: 500;">
                                    <strong> @ViewBag.MejorComprador </strong>comprando @ViewBag.MejorCantidad rifas
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    
    

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>¡Atención!</strong> @ViewBag.Error
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="rifas-grid">
        @foreach (var rifa in Model)
        {
            string estadoClase = rifa.state.ToString().ToLower();
            bool esDisponible = rifa.state == LogicaNegocio.Rifa.EstadoRifa.Disponible;

            <div class="rifa-box @estadoClase"
                 data-id="@rifa.id"
                 data-precio="@rifa.prize"
                 onclick="@(esDisponible ? $"seleccionarRifa({rifa.id})" : "")"
                 style="@(esDisponible ? "cursor: pointer;" : "")">

                <span class="numero-rifa">@rifa.id</span>
                @if (rifa.state == LogicaNegocio.Rifa.EstadoRifa.Vendido)
                {
                    <span class="precio-rifa">¡Vendido!</span>
                }
                else
                {
                    <span class="precio-rifa">$@rifa.prize</span>
                }

            </div>
        }
    </div>

    <button id="btnConfirmarSeleccion" class="btn btn-primary btn-lg shadow-lg">
        <i class="bi bi-cart-check me-2"></i> Comprar <span id="contadorRifas">0</span> rifas
    </button>
    </section>
</div>

<div class="modal fade" id="modalReserva" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="Reservar" id="formReserva" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reservar Rifa #<span id="labelIdRifa"></span></h5>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="idRifas" id="inputIdRifa" />

                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">NOMBRE COMPLETO</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                        <input type="text" name="nombre" class="form-control border-start-0 ps-0" placeholder="Nombre" required />
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-muted small">WHATSAPP (TELÉFONO)</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-telephone"></i></span>
                        <input type="tel"
                               name="telefono"
                               class="form-control"
                               placeholder="Celular"
                               pattern="[0-9]{8,11}"
                               title="Ingresa un número de teléfono válido (entre 8 y 11 números)"
                               required />
                        @*Esto es para que el form vaya viendo si ponen almenos 8 a 11 numeros*@
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-muted small">CORREO ELECTRÓNICO</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                        <input type="email" name="email" id="inputEmail" class="form-control border-start-0 ps-0" placeholder="Email" required />
                    </div>
                    <div id="errorEmail" class="text-danger mt-1" style="display:none; font-size: 0.75rem;">
                        Por favor, ingresa un correo válido para enviarte el comprobante.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-reserva-final btn-primary">Reservar ahora</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalInstrucciones" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold">📝 ÚLTIMO PASO</h5>
            </div>
            <div class="modal-body p-4 text-center">
                <i class="bi bi-bank text-success" style="font-size: 3rem;"></i>
                <h4 class="mt-3 fw-bold">¡Casi listo!</h4>
                <p class="text-muted">Para confirmar tu reserva, realiza la transferencia:</p>

                <div class="bg-light p-3 rounded-3 border text-start mb-3">
                    <p class="mb-1"><strong>Banco:</strong> ITAU (Caja de Ahorros)</p>
                    <div class="d-flex align-items-center mb-1">
                        <p class="mb-0"><strong>Número:</strong> <span id="numCuenta">3901430</span></p>
                        <button type="button" class="btn btn-sm btn-outline-dark border-0 py-0" onclick="copiarCuenta()" title="Copiar número">
                            <i class="bi bi-clipboard"></i> <span style="font-size: 0.75rem;">COPIAR</span>
                        </button>
                    </div>
                    <p class="mb-1"><strong>Titular:</strong> Agustín Carretto</p>
                    <p class="mb-0"><strong>Total:</strong> <span id="montoTotal" class="badge bg-success fs-6">$0</span></p>
                </div>
                <div id="alertaCopiado" class="text-success small fw-bold mb-2" style="display:none; transition: 0.3s;">
                    ✅ ¡Número copiado!
                </div>
                <p class="small text-dark fw-bold">⚠️ Envía el comprobante por WhatsApp para validar. ⚠️</p>

                <a id="btnEnviarComprobante" href="#" target="_blank" class="btn btn-success w-100 py-3 rounded-pill fw-bold">
                    <i class="bi bi-whatsapp"></i> ENVIAR COMPROBANTE
                </a>
            </div>
        </div>
    </div>
</div>


<div id="loaderOverlay" class="loader-overlay" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="text-white mt-3 fw-bold" style="letter-spacing: 2px;">PROCESANDO RESERVA...</h5>
        <p class="text-white-50 small">Asegurando tus números en Londres 2027</p>
    </div>
</div>


<hr style="width: 100px; border: 2px solid #2e7d32; margin: 10px auto;">

<section id="premios" class="py-5 bg-light">
    @await Html.PartialAsync("_SeccionPremios")
</section>








@section Scripts {

    <script>

        let rifasSeleccionadas = [];

        function seleccionarRifa(id) {
            const caja = document.querySelector(`.rifa-box[data-id="${id}"]`);
            const index = rifasSeleccionadas.indexOf(id);

            if (index > -1) {
                rifasSeleccionadas.splice(index, 1);
                caja.classList.remove('seleccionada-animada');
            } else {
                rifasSeleccionadas.push(id);
                caja.classList.add('seleccionada-animada');
            }

            actualizarInterfaz();
        }

        function actualizarInterfaz() {
            const btn = document.getElementById('btnConfirmarSeleccion');
            const contador = document.getElementById('contadorRifas');

            if (rifasSeleccionadas.length > 0) {
                btn.style.display = 'block';
                contador.innerText = rifasSeleccionadas.length;
            } else {
                btn.style.display = 'none';
            }
        }



        document.getElementById('btnConfirmarSeleccion').addEventListener('click', function () {

            document.getElementById('labelIdRifa').innerText = rifasSeleccionadas.join(", ");
            document.getElementById('inputIdRifa').value = rifasSeleccionadas.join(",");

            var modalElement = document.getElementById('modalReserva');
            var myModal = new bootstrap.Modal(modalElement);
            myModal.show();
        });






        $('#formReserva').submit(function (e) {
            e.preventDefault();


            $("#loaderOverlay").fadeIn(300);
            const instance = bootstrap.Modal.getInstance(document.getElementById('modalReserva'));
            if (instance) instance.hide();


            const form = $(this);

            $.post(form.attr('action'), form.serialize(), function (response) {
                $("#loaderOverlay").fadeOut(300, function () {
                    if (response.success) {
                        mostrarInstrucciones(response.ids, response.total);
                    } else {
                        alert("Error: " + response.message);
                    }
                });
            }).fail(function () {
                $("#loaderOverlay").hide();
                alert("Error de conexión con el servidor.");
            });
        });




        function mostrarInstrucciones(ids, monto) {
            document.getElementById('montoTotal').innerText = "$" + monto;


            let mensaje = `Hola Agus! 👋 Te envío el comprobante por las rifas: ${ids}. Total: $${monto}`;
            let encoded = encodeURIComponent(mensaje);

            document.getElementById('btnEnviarComprobante').href = `https://wa.me/59892114480?text=${encoded}`;

            new bootstrap.Modal(document.getElementById('modalInstrucciones')).show();

        }




        document.getElementById('modalInstrucciones').addEventListener('hidden.bs.modal', function () {
            location.reload();
        });


        function copiarCuenta() {
            const num = document.getElementById("numCuenta").innerText;

            navigator.clipboard.writeText(num).then(() => {
                const alerta = document.getElementById("alertaCopiado");

                alerta.style.display = "block";

                setTimeout(() => {
                    alerta.style.display = "none";
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        }


    </script>

}