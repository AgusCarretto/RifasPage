@model IEnumerable<LogicaNegocio.Rifa>
@section Styles {
    <link rel="stylesheet" href="~/css/rigas-grid.css" asp-append-version="true" />
}
@{
    ViewData["Title"] = "Venta de Rifas";
}



@if (!Model.Any())
{
    <div class="alert alert-info">No hay rifas cargadas en la base de datos.</div>
}


<div class="container">
    <div class="text-center my-5">
        <h1 class="brand-title">LONDRES 2027</h1>
        <p class="brand-subtitle">Sorteos & Rifas</p>
        <hr style="width: 50px; border: 2px solid #2e7d32; margin: 10px auto;">

        <div class="d-flex justify-content-center gap-3 mt-3">
            <span class="badge bg-success">Disponible</span>
            <span class="badge bg-warning text-dark">Pendiente/Reservado</span>
            <span class="badge bg-danger">No disponible</span>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h5 class="mb-3 fw-bold text-muted" style="letter-spacing: 2px; font-size: 0.8rem;">🎯 OBJETIVO DE LA COLECTA</h5>

                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped"
                         role="progressbar"
                         style="width: @ViewBag.Porcentaje%;"
                         aria-valuenow="@ViewBag.Porcentaje"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        @ViewBag.Porcentaje%
                    </div>
                </div>

                <p class="text-muted mb-4 fs-5 ">
                    ¡Ya completamos el <strong>@ViewBag.Porcentaje%</strong>! Solo quedan <strong>@ViewBag.RifasRestantes</strong> números.
                </p>

                <div class="d-inline-flex align-items-center p-2 px-4 bg-white rounded-pill shadow-sm border">
                    <span class="me-2">🏆</span>
                    <span class="text-muted small fw-bold text-uppercase" style="font-size: 0.70rem;">Líder de compras:</span>
                    <span class="ms-2 badge rounded-pill bg-black">@ViewBag.MejorComprador con @ViewBag.MejorCantidad </span>
                </div>
            </div>
        </div>
    </div>


    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>¡Atención!</strong> @ViewBag.Error
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="rifas-grid">
        @foreach (var rifa in Model)
        {
            string estadoClase = rifa.state.ToString().ToLower();
            bool esDisponible = rifa.state == LogicaNegocio.Rifa.EstadoRifa.Disponible;
            
            <div class="rifa-box @estadoClase"
                 onclick="@(esDisponible ? $"prepararReserva({rifa.id})" : "")"
                 style="@(esDisponible ? "cursor: pointer;" : "")">

                <span class="numero-rifa">@rifa.id</span>
                 @if (rifa.state == LogicaNegocio.Rifa.EstadoRifa.Vendido)
                {
                    <span class="precio-rifa">¡Vendido!</span>
                }
                else
                {
                    <span class="precio-rifa">$@rifa.prize</span>
                }
               
            </div>
        }
    </div>

</div>

<div class="modal fade" id="modalReserva" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="Reservar" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reservar Rifa #<span id="labelIdRifa"></span></h5>
            </div>
            <div class="modal-body">
                <input type="hidden" name="idRifa" id="inputIdRifa" />

                <div class="mb-3">
                    <label>Nombre Completo</label>
                    <input type="text" name="nombre" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label>Teléfono (WhatsApp)</label>
                    <input type="text" name="telefono" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Correo Electrónico</label>
                    <input type="email" name="email" id="inputEmail" class="form-control" required />
                    <div id="errorEmail" class="text-danger" style="display:none; font-size: 0.8rem; margin-top: 5px;">
                        Por favor, ingresa un correo electrónico válido.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Reservar ahora</button>
            </div>
        </form>
    </div>
</div>



@section Scripts {

    <script>
        function prepararReserva(id) {
            console.log("Intentando abrir rifa:", id); // Esto nos dirá en consola si la función responde

            // 1. Llenamos los datos en el formulario
            const inputId = document.getElementById('inputIdRifa');
            const labelId = document.getElementById('labelIdRifa');

            if (inputId) inputId.value = id;
            if (labelId) labelId.innerText = id;

            // 2. Abrimos el modal de forma manual
            // Buscamos el elemento
            var modalElement = document.getElementById('modalReserva');

            // Usamos la API de Bootstrap para mostrarlo
            if (typeof bootstrap !== 'undefined') {
                var myModal = new bootstrap.Modal(modalElement);
                myModal.show();
            } else {
                console.error("Error: Bootstrap JS no está cargado.");
                alert("Error de sistema: No se encontró la librería de Bootstrap.");
            }
        }

         


    </script>

}