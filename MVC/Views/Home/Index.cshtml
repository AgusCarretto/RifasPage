@model IEnumerable<LogicaNegocio.Rifa>

@{
    ViewData["Title"] = "Venta de Rifas";
}

<style>
    /* Contenedor principal de la grilla */
    .rifas-grid {
        display: grid;
        /* Crea columnas de mínimo 100px que llenan el espacio disponible */
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 15px;
        padding: 20px;
    }

    /* Estilo base de cada cuadrado (Rifa) */
    .rifa-box {
        aspect-ratio: 1 / 1; /* Hace que sean cuadrados perfectos */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        text-decoration: none;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 2px solid rgba(0,0,0,0.1);
    }

    .rifa-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        color: white;
    }

    /* Clases según el EstadoRifa (Enum) */
    /* Importante: el .ToLower() en el código asegura que coincidan */
    .disponible {
        background-color: #28a745; /* Verde */
        cursor: pointer;
    }

    .reservado {
        background-color: #ffc107; /* Amarillo/Naranja */
        color: #212529;
        cursor: wait;
    }

    .vendido {
        background-color: #dc3545; /* Rojo */
        cursor: not-allowed;
        opacity: 0.8;
    }

    .numero-rifa {
        font-size: 1.5rem;
    }

    .precio-rifa {
        font-size: 0.8rem;
        opacity: 0.9;
    }
</style>


@if (!Model.Any())
{
    <div class="alert alert-info">No hay rifas cargadas en la base de datos.</div>
}


<div class="container">
    <div class="text-center my-5">
        <h1 class="display-4">🎟️ Rifas Londres</h1>
        <p class="lead">Haz clic en un número verde para reservar tu rifa.</p>

        <div class="d-flex justify-content-center gap-3 mt-3">
            <span class="badge bg-success">Disponible</span>
            <span class="badge bg-warning text-dark">Pendiente/Reservado</span>
            <span class="badge bg-danger">No disponible</span>
        </div>
    </div>

    <div class="rifas-grid">
        @foreach (var rifa in Model)
        {
            @* Convertimos el Enum a minúsculas *@
            string estadoClase = rifa.state.ToString().ToLower();

            @* Lógica para el clic: Solo si está disponible *@
            string miClick = "";
            if (rifa.state == LogicaNegocio.Rifa.EstadoRifa.Disponible)
            {
                miClick = $"prepararReserva({rifa.id})";
            }

            <div class="rifa-box @estadoClase"
                 title="Estado: @rifa.state"
                 onclick="@miClick"
                 style="@(rifa.state == LogicaNegocio.Rifa.EstadoRifa.Disponible ? "cursor: pointer;" : "")">

                <span class="numero-rifa">#@rifa.id</span>
                <span class="precio-rifa">$@rifa.prize</span>

                @if (rifa.comprador != null)
                {
                    <small style="font-size: 0.6rem;">@rifa.comprador.name</small>
                }
            </div>
        }
    </div>

</div>

<div class="modal fade" id="modalReserva" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="Reservar" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reservar Rifa #<span id="labelIdRifa"></span></h5>
            </div>
            <div class="modal-body">
                <input type="hidden" name="idRifa" id="inputIdRifa" />

                <div class="mb-3">
                    <label>Nombre Completo</label>
                    <input type="text" name="nombre" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label>Teléfono (WhatsApp)</label>
                    <input type="text" name="telefono" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Correo Electrónico</label>
                    <input type="email" name="email" class="form-control" placeholder="ejemplo@correo.com" required />
                    <div class="invalid-feedback">Por favor, ingresa un correo válido.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Reservar ahora</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
    function prepararReserva(id) {
        console.log("Intentando abrir rifa:", id); // Esto nos dirá en consola si la función responde

        // 1. Llenamos los datos en el formulario
        const inputId = document.getElementById('inputIdRifa');
        const labelId = document.getElementById('labelIdRifa');
        
        if(inputId) inputId.value = id;
        if(labelId) labelId.innerText = id;

        // 2. Abrimos el modal de forma manual
        // Buscamos el elemento
        var modalElement = document.getElementById('modalReserva');
        
        // Usamos la API de Bootstrap para mostrarlo
        if (typeof bootstrap !== 'undefined') {
            var myModal = new bootstrap.Modal(modalElement);
            myModal.show();
        } else {
            console.error("Error: Bootstrap JS no está cargado.");
            alert("Error de sistema: No se encontró la librería de Bootstrap.");
        }
    }
</script>


}